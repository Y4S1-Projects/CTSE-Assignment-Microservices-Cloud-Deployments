name: Build, Scan & Deploy Microservices

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

permissions:
  contents: read
  packages: write
  id-token: write
  pull-requests: write

env:
  REGISTRY: ghcr.io
  AZURE_RESOURCE_GROUP: ctse-microservices-rg
  AZURE_LOCATION: eastus
  CONTAINER_REGISTRY_URL: ${{ secrets.AZURE_REGISTRY_URL }}

jobs:
  # ==================== MATRIX BUILD FOR ALL SERVICES ====================
  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, auth-service, catalog-service, order-service, payment-service]
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: maven

      - name: Build service - ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          mvn clean package -DskipTests --batch-mode

      - name: Test service - ${{ matrix.service }}
        continue-on-error: true
        run: |
          cd ${{ matrix.service }}
          mvn test --batch-mode

  # ==================== SECURITY SCANNING ====================
  security-scan:
    runs-on: ubuntu-latest
    needs: build-matrix
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  # ==================== BUILD & PUSH DOCKER IMAGES ====================
  build-docker:
    runs-on: ubuntu-latest
    needs: [build-matrix, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [api-gateway, auth-service, catalog-service, order-service, payment-service]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set lowercase repo name
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_LC }}/${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ env.REPO_LC }}/${{ matrix.service }}:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================== MANUAL DEPLOYMENT NOTICE ====================
  manual-deployment-notice:
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Check Deployment Status
        run: |
          echo "ðŸŽ‰ âœ… Docker images built successfully and pushed to GitHub Container Registry!"
          echo ""
          echo "ðŸ“¦ Container Images Ready:"
          echo "  â€¢ ghcr.io/${{ github.repository_owner }}/ctse-assignment-microservices-cloud-deployments/api-gateway:${{ github.sha }}"
          echo "  â€¢ ghcr.io/${{ github.repository_owner }}/ctse-assignment-microservices-cloud-deployments/auth-service:${{ github.sha }}"
          echo "  â€¢ ghcr.io/${{ github.repository_owner }}/ctse-assignment-microservices-cloud-deployments/catalog-service:${{ github.sha }}"
          echo "  â€¢ ghcr.io/${{ github.repository_owner }}/ctse-assignment-microservices-cloud-deployments/order-service:${{ github.sha }}"
          echo "  â€¢ ghcr.io/${{ github.repository_owner }}/ctse-assignment-microservices-cloud-deployments/payment-service:${{ github.sha }}"
          echo ""
          echo "âš ï¸  AZURE_CREDENTIALS secret not configured - Automatic deployment skipped"
          echo ""
          echo "ðŸš€ To deploy to Azure manually:"
          echo "1. Open PowerShell on your local machine"
          echo "2. Navigate to your project directory"
          echo "3. Run: az login"
          echo "4. Run: .\deploy-azure.ps1"
          echo ""
          echo "ðŸ“– See GITHUB_ACTIONS_FIX.md for no-permission deployment options"
          echo ""
          echo "ðŸ’¡ University accounts often lack permissions to create service principals."
          echo "   Manual deployment with 'az login' is the recommended approach."

  # ==================== DEPLOY TO AZURE CONTAINER APPS ====================
  deploy-to-azure:
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  AZURE_CREDENTIALS not configured - skipping deployment"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "âœ… AZURE_CREDENTIALS configured - proceeding with deployment"
          fi

      - name: Azure Login
        if: steps.check-creds.outputs.configured == 'true'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        id: azure-login

      - name: Verify Azure Authentication
        if: steps.check-creds.outputs.configured == 'true'
        run: |
          echo "ðŸ” Verifying Azure authentication..."
          az account show
          echo "âœ… Successfully authenticated to Azure"

      - name: Deploy Services to Azure Container Apps
        if: steps.check-creds.outputs.configured == 'true'
        run: |
          RG="${{ env.AZURE_RESOURCE_GROUP }}"
          ENV_NAME="ctse-env"
          LOCATION="${{ env.AZURE_LOCATION }}"
          REGISTRY="${{ env.REGISTRY }}"
          REPO_LC="${GITHUB_REPOSITORY,,}"
          IMAGE_TAG="${{ github.sha }}"

          echo "ðŸ“¦ Deployment Configuration:"
          echo "  Resource Group: $RG"
          echo "  Environment: $ENV_NAME"
          echo "  Location: $LOCATION"
          echo ""

          # Create Resource Group if not exists
          echo "ðŸ”§ Ensuring Resource Group exists..."
          az group create --name $RG --location $LOCATION --output none || true

          # Create Container Apps Environment if not exists
          echo "ðŸ—ï¸  Ensuring Container Apps Environment exists..."
          az containerapp env create \
            --name $ENV_NAME \
            --resource-group $RG \
            --location $LOCATION \
            --output none || echo "Environment already exists"

          # Deploy Auth Service (internal ingress)
          echo "ðŸš€ Deploying auth-service..."
          az containerapp create \
            --name auth-service \
            --resource-group $RG \
            --environment $ENV_NAME \
            --image $REGISTRY/$REPO_LC/auth-service:$IMAGE_TAG \
            --target-port 8081 \
            --ingress internal \
            --registry-server $REGISTRY \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 1 --max-replicas 3 \
            --output none || \
          az containerapp update \
            --name auth-service \
            --resource-group $RG \
            --image $REGISTRY/$REPO_LC/auth-service:$IMAGE_TAG \
            --set-env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --output none

          # Deploy Catalog Service (internal ingress)
          echo "ðŸš€ Deploying catalog-service..."
          az containerapp create \
            --name catalog-service \
            --resource-group $RG \
            --environment $ENV_NAME \
            --image $REGISTRY/$REPO_LC/catalog-service:$IMAGE_TAG \
            --target-port 8082 \
            --ingress internal \
            --registry-server $REGISTRY \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 1 --max-replicas 3 \
            --output none || \
          az containerapp update \
            --name catalog-service \
            --resource-group $RG \
            --image $REGISTRY/$REPO_LC/catalog-service:$IMAGE_TAG \
            --set-env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --output none

          # Deploy Order Service (internal ingress)
          echo "ðŸš€ Deploying order-service..."
          az containerapp create \
            --name order-service \
            --resource-group $RG \
            --environment $ENV_NAME \
            --image $REGISTRY/$REPO_LC/order-service:$IMAGE_TAG \
            --target-port 8083 \
            --ingress internal \
            --registry-server $REGISTRY \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 1 --max-replicas 3 \
            --output none || \
          az containerapp update \
            --name order-service \
            --resource-group $RG \
            --image $REGISTRY/$REPO_LC/order-service:$IMAGE_TAG \
            --set-env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --output none

          # Deploy Payment Service (internal ingress)
          echo "ðŸš€ Deploying payment-service..."
          az containerapp create \
            --name payment-service \
            --resource-group $RG \
            --environment $ENV_NAME \
            --image $REGISTRY/$REPO_LC/payment-service:$IMAGE_TAG \
            --target-port 8084 \
            --ingress internal \
            --registry-server $REGISTRY \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 1 --max-replicas 3 \
            --output none || \
          az containerapp update \
            --name payment-service \
            --resource-group $RG \
            --image $REGISTRY/$REPO_LC/payment-service:$IMAGE_TAG \
            --set-env-vars JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --output none

          # Deploy API Gateway (external ingress with service URLs)
          echo "ðŸš€ Deploying api-gateway..."
          az containerapp create \
            --name api-gateway \
            --resource-group $RG \
            --environment $ENV_NAME \
            --image $REGISTRY/$REPO_LC/api-gateway:$IMAGE_TAG \
            --target-port 8080 \
            --ingress external \
            --registry-server $REGISTRY \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --env-vars \
              JWT_SECRET=${{ secrets.JWT_SECRET }} \
              AUTH_SERVICE_URL=http://auth-service \
              CATALOG_SERVICE_URL=http://catalog-service \
              ORDER_SERVICE_URL=http://order-service \
              PAYMENT_SERVICE_URL=http://payment-service \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 2 --max-replicas 5 \
            --output none || \
          az containerapp update \
            --name api-gateway \
            --resource-group $RG \
            --image $REGISTRY/$REPO_LC/api-gateway:$IMAGE_TAG \
            --set-env-vars \
              JWT_SECRET=${{ secrets.JWT_SECRET }} \
              AUTH_SERVICE_URL=http://auth-service \
              CATALOG_SERVICE_URL=http://catalog-service \
              ORDER_SERVICE_URL=http://order-service \
              PAYMENT_SERVICE_URL=http://payment-service \
            --output none

          # Get API Gateway URL
          echo "ðŸŒ Getting API Gateway URL..."
          GATEWAY_URL=$(az containerapp show \
            --name api-gateway \
            --resource-group $RG \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)

          echo "âœ… Deployment Complete!"
          echo "API Gateway URL: https://$GATEWAY_URL"
          echo "GATEWAY_URL=$GATEWAY_URL" >> $GITHUB_ENV

      - name: Post Deployment Summary
        if: steps.check-creds.outputs.configured == 'true'
        run: |
          echo "## ðŸš€ Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… api-gateway (external)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… auth-service (internal)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… catalog-service (internal)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… order-service (internal)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… payment-service (internal)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ env.GATEWAY_URL }}" ]; then
            echo "### ðŸŒ API Gateway URL" >> $GITHUB_STEP_SUMMARY
            echo "https://${{ env.GATEWAY_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Test Endpoints:**" >> $GITHUB_STEP_SUMMARY
            echo "- Health: https://${{ env.GATEWAY_URL }}/health" >> $GITHUB_STEP_SUMMARY
            echo "- Swagger UI: https://${{ env.GATEWAY_URL }}/swagger-ui.html" >> $GITHUB_STEP_SUMMARY
            echo "- Auth Register: POST https://${{ env.GATEWAY_URL }}/auth/register" >> $GITHUB_STEP_SUMMARY
          fi

  # ==================== SMOKE TESTS ====================
  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy-to-azure
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Get API Gateway URL
        id: get-url
        run: |
          GATEWAY_URL=$(az containerapp show \
            --name api-gateway \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv 2>/dev/null || echo "")
          echo "url=$GATEWAY_URL" >> $GITHUB_OUTPUT

      - name: Smoke Test
        continue-on-error: true
        run: |
          echo "ðŸ§ª Running smoke tests..."
          GATEWAY_URL="${{ steps.get-url.outputs.url }}"

          if [ -z "$GATEWAY_URL" ]; then
            echo "âš ï¸  Could not retrieve Gateway URL. Skipping smoke tests."
            echo "ðŸ“ You may need to manually verify deployment in Azure Portal"
            exit 0
          fi

          echo "Testing Gateway URL: https://$GATEWAY_URL"

          # Test Gateway Health
          echo "Testing /health endpoint..."
          if curl -f -s -m 10 "https://$GATEWAY_URL/health"; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
          fi

          # Test Gateway Root
          echo "Testing / endpoint..."
          if curl -f -s -m 10 "https://$GATEWAY_URL/"; then
            echo "âœ… Root endpoint passed"
          else
            echo "âŒ Root endpoint failed"
          fi

          # Test Auth Service through Gateway
          echo "Testing /auth/health endpoint..."
          if curl -f -s -m 10 "https://$GATEWAY_URL/auth/health"; then
            echo "âœ… Auth health check passed"
          else
            echo "âŒ Auth health check failed"
          fi

          echo "âœ… Smoke tests completed"

  # ==================== FINAL REPORT ====================
  summary:
    runs-on: ubuntu-latest
    needs: [build-matrix, security-scan, build-docker, deploy-to-azure, smoke-test]
    if: always()
    steps:
      - name: Create Pipeline Summary
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker Images | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy to Azure | ${{ needs.deploy-to-azure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway (Port 8080)" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service (Port 8081)" >> $GITHUB_STEP_SUMMARY
          echo "- Catalog Service (Port 8082)" >> $GITHUB_STEP_SUMMARY
          echo "- Order Service (Port 8083)" >> $GITHUB_STEP_SUMMARY
          echo "- Payment Service (Port 8084)" >> $GITHUB_STEP_SUMMARY
